{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'css/trainResults.css' %}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
  <meta charset="UTF-8">
  <title>Admin Base</title>
</head>

<body>
  <script>
    var app = document.getElementsByTagName("BODY")[0];
    if (localStorage.lightMode == "dark") {
      app.setAttribute("light-mode", "dark");
    }
  </script>
  
  <!-- sideBar -->
  <div id="wrapper">
    <div id="leftWrapper">
      <div id="listView" class="list">
        <li><a href="#">Home</a></li>
        <li><a href="/trainModel">Train</a></li>
        <li><a href="/modifyDoctors">Users</a></li>
        <li><a href="/modifyImages">Images</a></li>
        <li><a href="/">Logout</a></li>
        <li style="position: absolute; top: 100%; height: 150px;">
          <button class="light-mode-button" aria-label="Toggle Light Mode" onclick="toggle_light_mode()">
            <span></span>
            <span></span>
          </button>
        </li>
      </div>
    </div>
    <!-- end of sideBar -->

    <!-- Content -->
    <div id="rightWrapper">
      <div id="header">
        <a id="fullPage" href="#">|||</a>
      </div>
      <div class="container-fluid">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <!-- DataTables -->
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"/>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>  
        <div class="row">
          <div class="col-md-6">
            <h1>Run Detail</h1>
            <table class="table table-striped">
              <tr>
                <th>Run ID</th>
                <td>{{ run.id }}</td>
              </tr>
              <tr>
                <th>Project</th>
                <td>{{ run.project }}</td>
              </tr>
              <tr>
                <th>Name</th>
                <td>{{ run.name }}</td>
              </tr>
              <tr>
                <th>Status</th>
                <td>{{ run.state }}</td>
              </tr>
              <tr>
                <th>Timestamp</th>
                <td>{{ run.created_at }}</td>
              </tr>
            </table>

          </div>

          <h1>Train Results</h1>
          <table id="train-table">
            <thead>
              <tr>
                <th>Epoch</th>
                <th>Step</th>
                <th>Train Loss</th>
              </tr>
            </thead>
            <tbody>
              {% for train in train_loss_data %}
              <tr>
                <td>{{ train.epoch }}</td>
                <td>{{ train.step }}</td>
                <td>{{ train.train_loss}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <script>
            $(document).ready(function () {
              $('#train-table').DataTable({
                "paging": true,
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                "searching": true,
                "info": true
              });
            });
          </script>


          <h1>Train Loss and Validation IOU Chart</h1>

          <div id="chart-container">
            <canvas id="combined-chart"></canvas>
          </div>

          <script>
            var trainLossData = {{ train_loss_data | safe }};
            var validationIouData = {{ validation_data | safe }};

            var ctx = document.getElementById('combined-chart').getContext('2d');
            var combinedChart = new Chart(ctx, {
              type: 'line',
              data: {
                datasets: [
                  {
                    label: 'Train Loss',
                    data: trainLossData.map(function (data) {
                      return { x: data.step, y: data.train_loss };
                    }),
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                  },
                  {
                    label: 'Validation Iou',
                    data: validationIouData.map(function (data) {
                      return { x: data.step, y: data.validation_Iou };
                    }),
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                  },
                  {
                    label: 'Learning Rate',
                    data: validationIouData.map(function (data) {
                      return { x: data.step, y: data.learning_rate };
                    }),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                  },
                  {
                    label: 'Epoch',
                    data: validationIouData.map(function (data) {
                      return { x: data.step, y: data.epoch };
                    }),
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                  }
                ]
              },
              options: {
                scales: {
                  xAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    ticks: {
                      stepSize: 1
                    },
                    scaleLabel: {
                      display: true,
                      labelString: 'Step'
                    }
                  }],
                  yAxes: [{
                    scaleLabel: {
                      display: true,
                      labelString: 'Value'
                    }
                  }]
                },
                title: {
                  display: true,
                  text: 'Combined Chart'
                },
                legend: {
                  display: true,
                  position: 'bottom'
                },
                tooltips: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function (tooltipItem, data) {
                      var label = data.datasets[tooltipItem.datasetIndex].label || '';
                      if (label) {
                        label += ': ';
                      }
                      label += tooltipItem.yLabel.toFixed(2);
                      return label;
                    }
                  }
                },
                plugins: {
                  zoom: {
                    pan: {
                      enabled: true,
                      mode: 'x'
                    },
                    zoom: {
                      enabled: true,
                      mode: 'x',
                      speed: 0.05
                    }
                  }
                }
              }
            });
          </script>

          {% if validation_data %}
          <h1>Validation Results</h1>
          <div class="image-grid">
            <table id="validation-table">
              <thead>
                <tr>
                  <th>Step</th>
                  <th>Epoch</th>
                  <th>Image</th>
                  <th>True Image</th>
                  <th>Predicted Image</th>
                  <th>validation Iou</th>
                </tr>
              </thead>
              <tbody>
                {% for validation in validation_data %}
                <tr>
                  <td>{{ validation.step }}</td>
                  <td>{{ validation.epoch }}</td>
                  <td><img src="{% url 'image_serve' image_path=validation.image_path %}"></td>
                  <td><img src="{% url 'image_serve' image_path=validation.mask_true_path %}"></td>
                  <td><img src="{% url 'image_serve' image_path=validation.mask_pred_path %}"></td>
                  <td>{{ validation.validation_Iou }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <script>
              $(document).ready(function () {
                $('#validation-table').DataTable({
                  "paging": true,
                  "searching": true,
                  "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                  "info": true,
                  "columnDefs": [
                    { "orderable": true, "targets": [0, 1, 5] },
                    { "orderable": false, "targets": [2, 3, 4] }
                  ]
                });
              });
            </script>
            <h1>Predict Masks</h1>
            <form method="post" id="predictionForm" action="/evaluation" enctype='multipart/form-data'>
              {% csrf_token %}
              <div>
                <label for="images">Upload Images:</label>
                <input type="file" name="images" multiple required>
              </div>
              <label for="images">Select checkpoint:</label>
              <select id="predict_checkpoint" name="predict_checkpoint">
                {% for file in checkpoints_files %}
                <option value="{{ checkpoints_dir }}/{{file}}">{{ file }}</option>
                {% endfor %}
              </select>
              <button type="submit">Upload</button>
            </form>
            {% endif %}

            <h1>Update Model</h1>
            <!-- add an ID to the form -->
            <form id="updateModel" name="updateModel" action="/update_model" method="post">
              {% csrf_token %}
              <label for="images">Select checkpoint:</label>
              <!-- add ID to the select element -->
              <select id="checkpoint" name="checkpoint">
                {% for file in checkpoints_files %}
                <option value="{{ checkpoints_dir }}/{{file}}">{{ file }}</option>
                {% endfor %}
              </select>

              <!-- add ID to the submit button -->
              <button id="submitBtn" type="submit">Upload</button>
            </form>
            <script>
              // handle form submission
              $('#updateModel').submit(function (event) {
                // prevent the default form submission behavior
                event.preventDefault();

                // get the form data
                var formData = new FormData(this);

                // send the AJAX request
                $.ajax({
                  url: $(this).attr('action'),
                  type: $(this).attr('method'),
                  data: formData,
                  processData: false,
                  contentType: false,
                  success: function (response) {
                    alert('The Model has been updated!')
                    console.log(response);
                  },
                  error: function (jqXHR, textStatus, errorThrown) {
                    alert('Failed to update the Model!')
                    console.error(textStatus, errorThrown);
                  }
                });
              });
            </script>

            </form>
          </div>
          <script type="text/javascript" src="{% static 'js/darkMode.js' %}"></script>
          <script type="text/javascript" src="{% static 'js/sideNav.js' %}"></script>
          <script type="text/javascript" src="{% static 'js/trainResults.js' %}"></script>
</body>

</html>