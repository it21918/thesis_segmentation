{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>

    <link rel="stylesheet" href="{% static 'css/trainResults.css' %}">
    <link rel="stylesheet" href="{% static 'css/stepper.css' %}">
    <link rel="stylesheet" href="{% static 'css/processStep.css' %}">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <meta charset="UTF-8">
    <title>Train Results</title>
</head>

<body>
{% include "componets/sideNav.html" %}
{% block content %}
    <div id="rightWrapper">
        <div id="header">
            <a id="fullPage" href="#">|||</a>
        </div>

        <div class="download-links" style="padding-top: 100px">
            <a href="{% url 'download_csv_train_results' run_id=run.id %}" class="download-link"
               style="font-size: 50px;">
                <i class="fas fa-file-csv"></i>
            </a>
        </div>


        <h1>Run Detail</h1>
        <table style="width: 200px">
            <tr>
                <th>Run</th>
                <td>{{ run.name }}</td>
            </tr>
            <tr>
                <th>Created by</th>
                <td>{{ run.trainer.username }}</td>
            </tr>
            <tr>
                <th>Status</th>
                <td>{{ run.status }}</td>
            </tr>
            <tr>
                <th>Timestamp</th>
                <td>{{ run.date }}</td>
            </tr>
        </table>


        <h1>Train Results</h1>
        <table id="train-table">
            <thead>
            <tr>
                <th>Epoch</th>
                <th>Step</th>
                <th>Train Loss</th>
            </tr>
            </thead>
            <tbody>
            {% for train in train_loss_data %}
                <tr>
                    <td>{{ train.epoch }}</td>
                    <td>{{ train.step }}</td>
                    <td>{{ train.train_loss }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
        <script>
            $(document).ready(function () {
                $('#train-table').DataTable({
                    "paging": true,
                    "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    "searching": true,
                    "info": true
                });
            });
        </script>


        <h1>Train Loss and Validation IOU Chart</h1>
        <div id="chart-container">
            <canvas id="combined-chart"></canvas>
        </div>

        <script>
            trainLossData = {{ train_loss_chart | safe }};
            validationIouData = {{ validation_chart | safe }};

            ctx = document.getElementById('combined-chart').getContext('2d');
            combinedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Train Loss',
                            data: trainLossData.map(function (data) {
                                return {x: data.step, y: data.train_loss};
                            }),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Validation Iou',
                            data: validationIouData.map(function (data) {
                                return {x: data.step, y: data.avg_validation_Iou};
                            }),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Learning Rate',
                            data: validationIouData.map(function (data) {
                                return {x: data.step, y: data.learning_rate};
                            }),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Epoch',
                            data: validationIouData.map(function (data) {
                                return {x: data.step, y: data.epoch};
                            }),
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        xAxes: [{
                            type: 'linear',
                            position: 'bottom',
                            ticks: {
                                stepSize: 1
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Step'
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Value'
                            }
                        }]
                    },
                    title: {
                        display: true,
                        text: 'Combined Chart'
                    },
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function (tooltipItem, data) {
                                var label = data.datasets[tooltipItem.datasetIndex].label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += tooltipItem.yLabel.toFixed(2);
                                return label;
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                enabled: true,
                                mode: 'x',
                                speed: 0.05
                            }
                        }
                    }
                }
            });
        </script>

        {% if validation_data %}
            <h1>Validation Results</h1>
            <div class="image-grid">
            <table id="validation-table">
                <thead>
                <tr>
                    <th>Step</th>
                    <th>Epoch</th>
                    <th>Image</th>
                    <th>True Image</th>
                    <th>Predicted Image</th>
                    <th>validation Iou</th>
                </tr>
                </thead>
                <tbody>
                {% for validation in validation_data %}
                    <tr>
                        <td>{{ validation.step }}</td>
                        <td>{{ validation.epoch }}</td>
                        <td><img src={{ validation.image.url }}></td>
                        <td><img src={{ validation.true_mask.url }}></td>
                        <td><img src={{ validation.pred_mask.url }}></td>
                        <td>{{ validation.validation_Iou }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <script>
                $(document).ready(function () {
                    $('#validation-table').DataTable({
                        "paging": true,
                        "searching": true,
                        "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                        "info": true,
                        "columnDefs": [
                            {"orderable": true, "targets": [0, 1, 5]},
                            {"orderable": false, "targets": [2, 3, 4]}
                        ]
                    });
                });
            </script>

            <h1>Update current run</h1>
                    <br />
<div class="wshipping-content-block service-process">
  <div class="container wow fadeInUp" style="visibility: visible; animation-name: fadeInUp;">
    <div class="row">
      <div class="col-md-6 col-md-offset-3">
        <div class="section-title">
          <h2>Updating model process</h2>
          <p>Below are the status to complete the auditing process</p>
          <br>
          <a href="{% url 'updateRunProcess' run.id %}">
            Begin process
          </a>
        </div>
      </div>
    </div>
    <div class="process-row" style="width: 100%">
      <div class="process-step">
        <div class="process-icon">
          <span>1</span>
          <img src="http://web24service.com/demo/w-shipping/assets/images/process-icon1.png" alt="">
        </div>
        <p class="delayed-text">Choose run checkpoint version</p>
      </div>
      <div class="process-step">
        <div class="process-icon">
          <span>2</span>
          <img src="http://web24service.com/demo/w-shipping/assets/images/process-icon2.png" alt="">
        </div>
        <p class="delayed-text">Choose images for mask prediction</p>
      </div>
      <div class="process-step">
        <div class="process-icon">
          <span>3</span>
          <img src="http://web24service.com/demo/w-shipping/assets/images/process-icon3.png" alt="">
        </div>
        <p class="delayed-text">Correct predicted masks</p>
      </div>
      <div class="process-step">
        <div class="process-icon">
          <span>4</span>
          <img src="http://web24service.com/demo/w-shipping/assets/images/process-icon4.png" alt="">
        </div>
        <p class="delayed-text">Train model with corrected masks</p>
      </div>
    </div>
  </div>
</div>
        {% endif %}


        <h1>Update running model</h1>
        <form id="updateModel" name="updateModel" action="/update_model" method="post">
            {% csrf_token %}
            <label for="images">Select checkpoint:</label>
            <select id="checkpoint" name="checkpoint">
                {% for checkpoint in checkpoints %}
                    <option value={{ checkpoint.file_path }}>checkpoint_{{ checkpoint.epoch }}</option>
                {% endfor %}
            </select>

            <button id="submitBtn" type="submit">Upload</button>
        </form>


        <script>
            // handle form submission
            $('#updateModel').submit(function (event) {
                // prevent the default form submission behavior
                event.preventDefault();

                // get the form data
                var formData = new FormData(this);

                // send the AJAX request
                $.ajax({
                    url: $(this).attr('action'),
                    type: $(this).attr('method'),
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        alert('The Model has been updated!')
                        console.log(response);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Failed to update the Model!')
                        console.error(textStatus, errorThrown);
                    }
                });
            });
        </script>
        </div>
    </div>
    <br>
{% endblock %}

<script type="text/javascript" src="{% static 'js/trainResults.js' %}"></script>
<script type="text/javascript" src="{% static 'js/stepper.js' %}"></script>
<script type="text/javascript" src="{% static 'js/processStep.js' %}"></script>
</body>

</html>